<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex" />
  <title>Sidekick Library</title>
  <script type="module" src="https://www.aem.live/tools/sidekick/library/index.js"></script>
  <style>
    html, body { margin:0; height:100%; background:#ededed; font-family:system-ui, sans-serif; }
  </style>
</head>
<body>
  <script>
    const ORG  = 'iain-mag';
    const REPO = 'dabc-training';
    const PREFIX = `/${ORG}/${REPO}/`;
    const SITE_ORIGIN = `https://main--${REPO}--${ORG}.aem.page`;

    function fixUrl(input) {
      // Build absolute URL using the site origin for relatives
      const u = new URL(input, SITE_ORIGIN);
      const host = u.hostname;

      // Only rewrite paths on aem.page / aem.live; NEVER touch content.da.live, etc.
      const isAemHost = host.endsWith('.aem.page') || host.endsWith('.aem.live');
      if (isAemHost && u.pathname.startsWith(PREFIX)) {
        u.pathname = u.pathname.slice(PREFIX.length - 1); // remove "/org/repo"
      }
      return u.toString();
    }

    // Patch fetch
    const _fetch = window.fetch;
    window.fetch = (input, init) => {
      try {
        const url = (input && input.url) ? input.url : input;
        return _fetch(fixUrl(url), init);
      } catch { return _fetch(input, init); }
    };

    // Patch XHR
    const _open = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(method, url, ...rest) {
      try { url = fixUrl(url); } catch {}
      return _open.call(this, method, url, ...rest);
    };

    // One-time sweep for existing href/src
    function sweep(root=document) {
      root.querySelectorAll('a[href], img[src], link[href], source[src]').forEach(el => {
        if (el.hasAttribute('href')) el.href = fixUrl(el.getAttribute('href'));
        if (el.hasAttribute('src'))  el.src  = fixUrl(el.getAttribute('src'));
      });
    }
    sweep();

    // Render the Library from your absolute DA JSON (won't be rewritten)
    const el = document.createElement('sidekick-library');
    el.config = {
      base: 'https://content.da.live/iain-mag/dabc-training/docs/library/blocks.json'
    };
    document.body.prepend(el);
  </script>
</body>
</html>
